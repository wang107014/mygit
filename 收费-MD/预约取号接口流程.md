#预约取号
1、主要参数：登记号、预约单号、操作员工号、支付方式代码

##流程：

1、根据预约单号从RB_Appointment表中取出这条数据。    
1.1、如果没有这条数据则，则不存在这条预约记录。    
1.2、判断这条数据中的一个状态(APPT_Status),I是正常的,A是已取号,X是已取消,J是已违约,如果不是正常的，则会取号失败，原因就是：已取号、已取消、已违约等。
1.3、根据这条记录中的APPT_PAPMI_DR字段值从病人表（PA_PatMas）取出一条记录来和登记号判断是否是同一个人,如果不是则会取号失败，原因就是：非公共卡预约只能本人取号

2、如果登记号不传入，取号则会失败，原因就是：病人登记号不得为空

3、如果操作员工号(例如ZZ001、SF01)输入不正确或为空,取号则会失败,原因就是：操作员代码不正确或为空

4、如果登记号输入错误，取号则会失败,原因就是：检索不到病人记录

5、根据登记号来判断卡是正常还是挂失回收或作废,如果不是正常的，则会取号失败,原因就是：患者没有对应有效的卡记录。

6、根据传入的支付方式代码(例如WX、ZFB,CPP)得到HIS需要的支付方式ID,如果没有HIS需要的支付方式ID,则会取号失败，原因就是：系统中未找到此支付方式
6.1、如果传入的支付方式是CPP(预交金),则会根据登记号、预约单号中的信息来获取到卡账户中的余额和预约号所需要的费用,如果卡账户中余额小于预约号所需要的费用,则取号会失败，原因就是：账户余额不足以支付此费用！

7、根据预约单号中的信息从^DHCRBCASStatus中取出一个状态来判断预约的排班是否已停诊(S:停诊、N:正常)，如果已停诊，则会取号失败，原因就是：此排班已停诊



8、正式取号
8.1、根据预约单号从RB_Appointment表中取出这条记录。 
8.2、从这条记录中取出所预约的第几号源。（插入分诊排队记录表中需要）
8.3、根据预约单号中的信息从^DHCRBCASStatus中取出一个状态来判断预约的排班是否已停诊(S:停诊、N:正常)，如果已停诊，则会取号失败，原因就是：此排班已停诊
8.4、根据登记号获取获取病人表中的对应id，根据预约单号中的信息从^RB中获取就诊类型、就诊科室、就诊医生、就诊日期、就诊时间等信息，然后把这些信息存进就诊表(PA_Adm)中,形成一条新的记录。
8.5、更新RB_Appointment中的状态(APPT_Status)为A(已取号),日期、时间、操作人员、就诊id
8.6、在医嘱表(OE_Order)中新增一条挂号医嘱记录,如果插入失败、则取号会失败，原因就是：PriceArcOrderInsertFail
8.7、如果没有传入支付方式、默认为现金，调用HIS中的结算方法来收取挂号费用。	如果结算失败，则取号会失败，原因就是：FailCharge
8.8、结算成功后，在挂号表中(DHCRegistrationFee)中插入一条新的记录,如果插入失败，则会取号失败,原因就是：RegFeeInsertFail
8.9、挂号表新增记录成功后，在分诊排队记录表(DHC_Queue)中插入一条新的记录,如果插入失败,则会取号失败,原因就是：QueueInsertFail
8.10、分诊排队记录表新增记录成功后，获取取号成功时所需要返回的信息


9、生HIS交易流水号，在交易流水表(DHC_BillExtTradePay)中新增一条待支付的流水交易记录,如果插入失败，则会取号失败,原因就是：生成交易流水号失败！
9.1、根据新增流水交易记录的id和一些信息,把交易流水表(DHC_BillExtTradePay)中这条记录更新为支付成功状态和一些相关的信息。
9.2、在交易关联表(DHC_BillExtTradeConSub)中新增一条交易关联记录,如果插入记录失败，则会取号失败，原因就是：保存交易信息失败

10、取号成功，返回取号成功时所需要的信息


